<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯»é“å¤§åƒçµå…½æ´—ç‚¼æ¨¡æ‹Ÿ</title>
    <style>
/* å…¨å±€æ ·å¼é‡ç½® */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Microsoft YaHei', Arial, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    min-height: 100vh;
    color: #fff;
    overflow-x: hidden;
}

.container {
    max-width: 480px;
    margin: 0 auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
}

/* å¤´éƒ¨æ ·å¼ */
.header {
    background: rgba(0, 0, 0, 0.6);
    padding: 15px 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.header h1 {
    font-size: 20px;
    font-weight: 500;
    color: #ffd700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

/* ä¸»å†…å®¹åŒº */
.main-content {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* çµå…½å±•ç¤ºåŒº */
.creature-display {
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.creature-icon {
    font-size: 80px;
    margin-bottom: 10px;
    filter: drop-shadow(0 4px 8px rgba(255, 215, 0, 0.3));
}

.creature-name {
    font-size: 18px;
    color: #ffd700;
    margin-top: 8px;
}

.star-rating {
    color: #ffd700;
    font-size: 20px;
    letter-spacing: 3px;
}

/* ç»“æœåŒºåŸŸ */
.result-section {
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
    border-radius: 15px;
    padding: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.result-title {
    text-align: center;
    font-size: 18px;
    color: #ffd700;
    margin-bottom: 20px;
    font-weight: 500;
}

/* è¯æ¡è¡Œ */
.stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 10px;
}

.stat-box {
    background: rgba(100, 149, 237, 0.2);
    border: 2px solid rgba(100, 149, 237, 0.5);
    border-radius: 10px;
    padding: 15px 8px;
    text-align: center;
    transition: all 0.3s ease;
    min-height: 75px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.stat-name {
    font-size: 14px;
    color: #fff;
    margin-bottom: 6px;
    line-height: 1.3;
    word-wrap: break-word;
    font-weight: 500;
}

.stat-level {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.7);
}

/* å“è´¨æ ·å¼ */
.stat-box.quality-gold {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 215, 0, 0.1) 100%);
    border-color: #ffd700;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.4), inset 0 0 10px rgba(255, 215, 0, 0.1);
}

.stat-box.quality-gold .stat-name,
.stat-box.quality-gold .stat-level {
    color: #ffd700;
}

.stat-box.quality-purple {
    background: linear-gradient(135deg, rgba(186, 85, 211, 0.25) 0%, rgba(186, 85, 211, 0.1) 100%);
    border-color: #ba55d3;
    box-shadow: 0 0 15px rgba(186, 85, 211, 0.3);
}

.stat-box.quality-purple .stat-name,
.stat-box.quality-purple .stat-level {
    color: #e8b4f8;
}

.stat-box.quality-blue {
    background: linear-gradient(135deg, rgba(100, 149, 237, 0.25) 0%, rgba(100, 149, 237, 0.1) 100%);
    border-color: #6495ed;
}

.stat-box.quality-blue .stat-name,
.stat-box.quality-blue .stat-level {
    color: #87ceeb;
}

/* é”å®šæ§½ä½æ ‡è®° */
.stat-box.locked-slot::after {
    content: 'ğŸ”’';
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 10px;
    opacity: 0.6;
}

.stat-box.locked-slot {
    position: relative;
    box-shadow: inset 0 0 10px rgba(255, 215, 0, 0.15);
}

/* ç®­å¤´æŒ‡ç¤º */
.arrow-indicator {
    text-align: center;
    padding: 10px 0;
    position: relative;
}

.lock-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 8px;
}

/* é”å®šæŒ‰é’® */
.lock-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    margin: 0 auto;
}

.lock-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.lock-btn:active {
    transform: scale(0.95);
}

.lock-btn.locked {
    background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }
    50% {
        box-shadow: 0 4px 16px rgba(255, 215, 0, 0.6);
    }
}

.lock-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
}

/* ç®­å¤´æŒ‡ç¤º */
.arrow-indicator {
    text-align: center;
    padding: 8px 0;
}

.arrow {
    font-size: 20px;
    color: #ffd700;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(5px); }
}

/* æ–°è¯æ¡è¡Œé«˜äº® */
.new-stats .stat-box {
    transform: scale(1.02);
}

/* ææ–™æ¶ˆè€—æ˜¾ç¤º */
.cost-display {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 20px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.cost-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.cost-icon {
    font-size: 20px;
}

.cost-label {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.8);
}

.cost-value {
    font-size: 16px;
    color: #ffd700;
    font-weight: bold;
    min-width: 30px;
    text-align: right;
}

/* æ´—ç‚¼æ¨¡å¼æŒ‰é’® */
.wash-buttons {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

/* å°æŒ‰é’®æ ·å¼ */
.btn-small {
    padding: 8px 16px;
    font-size: 14px;
    width: auto;
    margin-top: 15px;
    opacity: 0.7;
}

.btn-small:hover {
    opacity: 1;
}

/* ææ–™ç»Ÿè®¡æ˜¾ç¤º */
.stats-summary {
    background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.stats-title {
    text-align: center;
    font-size: 14px;
    color: #ffd700;
    margin-bottom: 12px;
    font-weight: 500;
}

.stats-items {
    display: flex;
    justify-content: center;
    gap: 30px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.stat-icon {
    font-size: 18px;
}

.stat-text {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.7);
}

.stat-value {
    font-size: 15px;
    color: #87ceeb;
    font-weight: bold;
    min-width: 25px;
    text-align: right;
}

.btn {
    flex: 1;
    padding: 14px 24px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn-secondary {
    background: linear-gradient(135deg, #dc143c 0%, #b22222 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(220, 20, 60, 0.4);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #ff1744 0%, #dc143c 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(220, 20, 60, 0.6);
}

.btn-secondary:active {
    transform: translateY(0);
}

.btn-primary {
    background: linear-gradient(135deg, #ff8c00 0%, #ff6347 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 140, 0, 0.6);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.stat-box.animate {
    animation: fadeIn 0.4s ease-out;
}

/* è¯æ¡é€‰æ‹©ç•Œé¢æ ·å¼ */
.selection-mode {
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
    border-radius: 15px;
    padding: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.selectors-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.trait-selector {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.selector-label {
    font-size: 14px;
    color: #ffd700;
    margin-bottom: 10px;
    text-align: center;
    font-weight: 500;
}

.type-select,
.quality-select {
    width: 100%;
    padding: 10px;
    margin-bottom: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.type-select:hover,
.quality-select:hover {
    border-color: rgba(255, 215, 0, 0.5);
    background: rgba(0, 0, 0, 0.4);
}

.type-select:focus,
.quality-select:focus {
    outline: none;
    border-color: #ffd700;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

.type-select option,
.quality-select option {
    background: #1a1a2e;
    color: #fff;
    padding: 10px;
}

.selection-footer {
    display: flex;
    justify-content: center;
}

.btn-large {
    padding: 16px 40px;
    font-size: 18px;
}

/* é‡æ–°é€‰æ‹©æŒ‰é’® */
#resetBtn {
    width: 100%;
    margin-top: 20px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 400px) {
    .stats-row {
        gap: 5px;
    }

    .stat-box {
        padding: 10px 4px;
        min-height: 60px;
    }

    .stat-name {
        font-size: 12px;
    }

    .stat-level {
        font-size: 9px;
    }

    .selectors-container {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>çµå…½æ´—ç‚¼æ¨¡æ‹Ÿ</h1>
        </header>

        <main class="main-content">
            <div class="creature-display">
                <div class="creature-icon">ğŸ¦</div>
                <div class="creature-info">
                    <div class="star-rating">â˜…â˜…â˜…â˜…â˜…</div>
                </div>
            </div>

            <!-- è¯æ¡é€‰æ‹©ç•Œé¢ -->
            <div class="selection-mode" id="selectionMode">
                <div class="result-title">é€‰æ‹©åˆå§‹è¯æ¡</div>

                <div class="selectors-container">
                    <div class="trait-selector" data-index="0">
                        <div class="selector-label">æ§½ä½ 1</div>
                        <select class="type-select" id="type-0">
                            <option value="">é€‰æ‹©ç±»å‹</option>
                        </select>
                        <select class="quality-select" id="quality-0">
                            <option value="">é€‰æ‹©å“è´¨</option>
                            <option value="GOLD">é‡‘</option>
                            <option value="PURPLE">ç´«</option>
                            <option value="BLUE">è“</option>
                        </select>
                    </div>

                    <div class="trait-selector" data-index="1">
                        <div class="selector-label">æ§½ä½ 2</div>
                        <select class="type-select" id="type-1">
                            <option value="">é€‰æ‹©ç±»å‹</option>
                        </select>
                        <select class="quality-select" id="quality-1">
                            <option value="">é€‰æ‹©å“è´¨</option>
                            <option value="GOLD">é‡‘</option>
                            <option value="PURPLE">ç´«</option>
                            <option value="BLUE">è“</option>
                        </select>
                    </div>

                    <div class="trait-selector" data-index="2">
                        <div class="selector-label">æ§½ä½ 3</div>
                        <select class="type-select" id="type-2">
                            <option value="">é€‰æ‹©ç±»å‹</option>
                        </select>
                        <select class="quality-select" id="quality-2">
                            <option value="">é€‰æ‹©å“è´¨</option>
                            <option value="GOLD">é‡‘</option>
                            <option value="PURPLE">ç´«</option>
                            <option value="BLUE">è“</option>
                        </select>
                    </div>

                    <div class="trait-selector" data-index="3">
                        <div class="selector-label">æ§½ä½ 4</div>
                        <select class="type-select" id="type-3">
                            <option value="">é€‰æ‹©ç±»å‹</option>
                        </select>
                        <select class="quality-select" id="quality-3">
                            <option value="">é€‰æ‹©å“è´¨</option>
                            <option value="GOLD">é‡‘</option>
                            <option value="PURPLE">ç´«</option>
                            <option value="BLUE">è“</option>
                        </select>
                    </div>
                </div>

                <div class="selection-footer">
                    <button class="btn btn-large btn-primary" id="startBtn" disabled>å¼€å§‹æ´—ç‚¼</button>
                </div>
            </div>

            <!-- æ´—ç‚¼ç•Œé¢ -->
            <div class="result-section" id="washMode" style="display: none;">
                <div class="result-title">æ´—ç‚¼ç»“æœ</div>

                <!-- åŸè¯æ¡ -->
                <div class="stats-row original-stats">
                    <div class="stat-box" id="original-0">
                        <div class="stat-name">-</div>
                        <div class="stat-level"></div>
                    </div>
                    <div class="stat-box" id="original-1">
                        <div class="stat-name">-</div>
                        <div class="stat-level"></div>
                    </div>
                    <div class="stat-box" id="original-2">
                        <div class="stat-name">-</div>
                        <div class="stat-level"></div>
                    </div>
                    <div class="stat-box" id="original-3">
                        <div class="stat-name">-</div>
                        <div class="stat-level"></div>
                    </div>
                </div>

                <!-- ç®­å¤´æŒ‡ç¤ºå’Œé”å®šæŒ‰é’® -->
                <div class="arrow-indicator">
                    <div class="lock-row">
                        <button class="lock-btn" id="lock-0" data-index="0">ğŸ”“</button>
                        <button class="lock-btn" id="lock-1" data-index="1">ğŸ”“</button>
                        <button class="lock-btn" id="lock-2" data-index="2">ğŸ”“</button>
                        <button class="lock-btn" id="lock-3" data-index="3">ğŸ”“</button>
                    </div>
                    <span class="arrow">â–¼</span>
                </div>

                <!-- æ–°è¯æ¡ -->
                <div class="stats-row new-stats">
                    <div class="stat-box" id="new-0">
                        <div class="stat-name">-</div>
                        <div class="stat-level"></div>
                    </div>
                    <div class="stat-box" id="new-1">
                        <div class="stat-name">-</div>
                        <div class="stat-level"></div>
                    </div>
                    <div class="stat-box" id="new-2">
                        <div class="stat-name">-</div>
                        <div class="stat-level"></div>
                    </div>
                    <div class="stat-box" id="new-3">
                        <div class="stat-name">-</div>
                        <div class="stat-level"></div>
                    </div>
                </div>

                <!-- ææ–™æ¶ˆè€—æ˜¾ç¤º -->
                <div class="cost-display">
                    <div class="cost-item">
                        <span class="cost-icon">ğŸ’</span>
                        <span class="cost-label">æ´—ç‚¼çŸ³</span>
                        <span class="cost-value" id="washStone">20</span>
                    </div>
                    <div class="cost-item">
                        <span class="cost-icon">ğŸª¨</span>
                        <span class="cost-label">ä¸åŒ–å²©</span>
                        <span class="cost-value" id="lockStone">0</span>
                    </div>
                </div>
            </div>

            <!-- ææ–™ç»Ÿè®¡æ˜¾ç¤º -->
            <div class="stats-summary" id="statsSummary" style="display: none;">
                <div class="stats-title">ç´¯è®¡æ¶ˆè€—</div>
                <div class="stats-items">
                    <div class="stat-item">
                        <span class="stat-icon">ğŸ’</span>
                        <span class="stat-text">æ´—ç‚¼çŸ³</span>
                        <span class="stat-value" id="totalWashStone">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">ğŸª¨</span>
                        <span class="stat-text">ä¸åŒ–å²©</span>
                        <span class="stat-value" id="totalLockStone">0</span>
                    </div>
                </div>
            </div>

            <!-- æ´—ç‚¼æ¨¡å¼æŒ‰é’® -->
            <div class="wash-buttons" id="washButtons" style="display: none;">
                <button class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="washBtn">æ´—ç‚¼</button>
            </div>

            <!-- é‡æ–°é€‰æ‹©æŒ‰é’® -->
            <button class="btn btn-small btn-secondary" id="resetBtn" style="display: none;">â†» é‡æ–°é€‰æ‹©</button>
        </main>
    </div>

    <script>
// è¯æ¡ç±»å‹å®šä¹‰ï¼ˆ22ç§ï¼‰
const TRAIT_TYPES = [
    'æ”»å‡»', 'é˜²å¾¡', 'ç”Ÿå‘½', 'æ•æ·',
    'å‡»æ™•', 'æš´å‡»', 'è¿å‡»', 'é—ªé¿', 'åå‡»', 'å¸è¡€',
    'æŠµæŠ—å‡»æ™•', 'æŠµæŠ—æš´å‡»', 'æŠµæŠ—è¿å‡»', 'æŠµæŠ—é—ªé¿', 'æŠµæŠ—åå‡»', 'æŠµæŠ—å¸è¡€',
    'å¼ºåŒ–çµå…½', 'å¼±åŒ–çµå…½',
    'å¼ºåŒ–æ²»ç–—', 'å¼±åŒ–æ²»ç–—',
    'å¼ºåŒ–æš´ä¼¤', 'å¼±åŒ–æš´ä¼¤'
];

// è¯æ¡å“è´¨å®šä¹‰
const QUALITY = {
    GOLD: { name: 'é‡‘', probability: 0.032, class: 'quality-gold' },
    PURPLE: { name: 'ç´«', probability: 0.01, class: 'quality-purple' },
    BLUE: { name: 'è“', probability: 0.005, class: 'quality-blue' }
};

// è¯æ¡ç±»
class Trait {
    constructor(type, quality) {
        this.type = type;
        this.quality = quality;
    }

    // è·å–è¯æ¡å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºæ¯”è¾ƒæ˜¯å¦ç›¸åŒï¼‰
    getId() {
        return `${this.type}-${this.quality.name}`;
    }

    // è·å–æ˜¾ç¤ºä¿¡æ¯
    getDisplayInfo() {
        return {
            name: this.type,
            quality: this.quality
        };
    }
}

// è¯æ¡æ´—ç‚¼å™¨
class TraitWasher {
    constructor() {
        this.currentTraits = [];
        this.newTraits = [];
        this.lockedSlots = [false, false, false, false]; // é”å®šçŠ¶æ€
        this.traitPool = this.createTraitPool();
        this.totalWashStone = 0; // æ€»æ´—ç‚¼çŸ³æ¶ˆè€—
        this.totalLockStone = 0; // æ€»ä¸åŒ–å²©æ¶ˆè€—
    }

    // åˆ›å»ºæ‰€æœ‰66ç§è¯æ¡çš„æ± å­ï¼ˆ22ç§ç±»å‹ Ã— 3ç§å“è´¨ï¼‰
    createTraitPool() {
        const pool = [];
        for (const type of TRAIT_TYPES) {
            for (const qualityKey of ['GOLD', 'PURPLE', 'BLUE']) {
                const quality = QUALITY[qualityKey];
                const trait = new Trait(type, quality);
                pool.push({
                    trait: trait,
                    probability: this.getProbability(qualityKey)
                });
            }
        }
        return pool;
    }

    // è·å–å“è´¨æ¦‚ç‡
    getProbability(qualityKey) {
        switch (qualityKey) {
            case 'GOLD': return 0.5;
            case 'PURPLE': return 1.0;
            case 'BLUE': return 3.2;
            default: return 0;
        }
    }

    // ä»æ± å­ä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„ä¸é‡å¤è¯æ¡
    selectFromPool(count, excludeIds = new Set()) {
        const selected = [];
        const available = this.traitPool.filter(item => !excludeIds.has(item.trait.getId()));
        const selectedIndices = new Set();

        while (selected.length < count && selected.length < available.length) {
            // è®¡ç®—å½“å‰å¯ç”¨çš„æ€»æ¦‚ç‡
            const totalProb = available.reduce((sum, item, index) => {
                return selectedIndices.has(index) ? sum : sum + item.probability;
            }, 0);

            const rand = Math.random() * totalProb;
            let cumulative = 0;

            for (let i = 0; i < available.length; i++) {
                if (selectedIndices.has(i)) continue;

                cumulative += available[i].probability;
                if (rand < cumulative) {
                    selectedIndices.add(i);
                    selected.push(available[i].trait);
                    break;
                }
            }
        }

        return selected;
    }

    // æ´—ç‚¼è¯æ¡ï¼ˆç”Ÿæˆ4ä¸ªä¸é‡å¤çš„è¯æ¡ï¼‰
    wash() {
        // è®°å½•ææ–™æ¶ˆè€—
        this.recordMaterialUsage();

        // ç¬¬ä¸€æ¬¡æ´—ç‚¼æ—¶ï¼Œä¸Šæ ä¸ºç©ºï¼Œç»“æœæ˜¾ç¤ºåœ¨ä¸‹æ 
        if (this.currentTraits.length === 0) {
            this.newTraits = this.selectFromPool(4);
        } else {
            // æœ‰é”å®šçš„è¯æ¡ï¼Œæ´—ç‚¼æ—¶éœ€è¦ä¿ç•™é”å®šçš„è¯æ¡
            const newTraits = [];
            const lockedIndices = [];
            const excludeIds = new Set();

            // æ”¶é›†é”å®šçš„è¯æ¡
            for (let i = 0; i < 4; i++) {
                if (this.lockedSlots[i] && this.currentTraits[i]) {
                    lockedIndices.push(i);
                    excludeIds.add(this.currentTraits[i].getId());
                }
            }

            // ç”Ÿæˆæœªé”å®šçš„è¯æ¡
            const unlockedCount = 4 - lockedIndices.length;
            if (unlockedCount > 0) {
                const generatedTraits = this.selectFromPool(unlockedCount, excludeIds);
                let genIndex = 0;

                for (let i = 0; i < 4; i++) {
                    if (this.lockedSlots[i] && this.currentTraits[i]) {
                        // ä¿ç•™é”å®šçš„è¯æ¡
                        newTraits[i] = this.currentTraits[i];
                    } else {
                        // ä½¿ç”¨æ–°ç”Ÿæˆçš„è¯æ¡
                        newTraits[i] = generatedTraits[genIndex++];
                    }
                }
            } else {
                // å…¨éƒ¨é”å®šï¼Œä¸ä¼šå‘ç”Ÿ
                newTraits.push(...this.currentTraits);
            }

            this.newTraits = newTraits;
        }

        return {
            current: this.currentTraits,
            new: this.newTraits
        };
    }

    // ä¿å­˜æ´—ç‚¼ç»“æœ
    saveResult() {
        if (this.newTraits.length > 0) {
            this.currentTraits = [...this.newTraits];
            this.newTraits = [];
            return true;
        }
        return false;
    }

    // å–æ¶ˆæ´—ç‚¼
    cancel() {
        this.newTraits = [];
        return {
            current: this.currentTraits,
            new: []
        };
    }

    // è·å–å½“å‰è¯æ¡
    getCurrentTraits() {
        return this.currentTraits;
    }

    // è®¾ç½®å½“å‰è¯æ¡
    setCurrentTraits(traits) {
        this.currentTraits = [...traits];
    }

    // è·å–æ–°è¯æ¡
    getNewTraits() {
        return this.newTraits;
    }

    // é‡ç½®
    reset() {
        this.currentTraits = [];
        this.newTraits = [];
        this.lockedSlots = [false, false, false, false];
        this.totalWashStone = 0;
        this.totalLockStone = 0;
    }

    // è®°å½•ææ–™æ¶ˆè€—
    recordMaterialUsage() {
        const washStoneCost = this.getWashStoneCost();
        const lockStoneCost = this.getLockCost();
        this.totalWashStone += washStoneCost;
        this.totalLockStone += lockStoneCost;
    }

    // è·å–æ€»æ´—ç‚¼çŸ³æ¶ˆè€—
    getTotalWashStone() {
        return this.totalWashStone;
    }

    // è·å–æ€»ä¸åŒ–å²©æ¶ˆè€—
    getTotalLockStone() {
        return this.totalLockStone;
    }

    // åˆ‡æ¢é”å®šçŠ¶æ€
    toggleLock(index) {
        if (index >= 0 && index < 4) {
            this.lockedSlots[index] = !this.lockedSlots[index];
            return this.lockedSlots[index];
        }
        return false;
    }

    // è·å–é”å®šçŠ¶æ€
    getLockState() {
        return [...this.lockedSlots];
    }

    // è®¾ç½®é”å®šçŠ¶æ€
    setLockState(lockedSlots) {
        this.lockedSlots = [...lockedSlots];
    }

    // è®¡ç®—é”å®šææ–™æ¶ˆè€—
    getLockCost() {
        const lockedCount = this.lockedSlots.filter(l => l).length;
        switch (lockedCount) {
            case 0: return 0;
            case 1: return 20;
            case 2: return 40;
            case 3: return 100;
            default: return 0; // é”å®š4ä¸ªæ²¡æœ‰æ„ä¹‰
        }
    }

    // è·å–æ´—ç‚¼çŸ³æ¶ˆè€—ï¼ˆå›ºå®š20ï¼‰
    getWashStoneCost() {
        return 20;
    }
}

// åº”ç”¨ç¨‹åºä¸»é€»è¾‘
class App {
    constructor() {
        this.washer = new TraitWasher();
        this.isWashing = false;
        this.isSelectionMode = true;
        this.init();
    }

    // åˆå§‹åŒ–åº”ç”¨
    init() {
        this.populateTypeDropdowns();
        this.bindEvents();
        this.displayInitialStats();
        this.updateButtons();
        this.updateUI();
    }

    // å¡«å……ç±»å‹ä¸‹æ‹‰èœå•
    populateTypeDropdowns() {
        for (let i = 0; i < 4; i++) {
            const typeSelect = document.getElementById(`type-${i}`);
            TRAIT_TYPES.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }
    }

    // æ›´æ–°ç•Œé¢æ¨¡å¼
    updateUI() {
        const selectionMode = document.getElementById('selectionMode');
        const washMode = document.getElementById('washMode');
        const washButtons = document.getElementById('washButtons');
        const resetBtn = document.getElementById('resetBtn');
        const statsSummary = document.getElementById('statsSummary');

        if (this.isSelectionMode) {
            selectionMode.style.display = 'block';
            washMode.style.display = 'none';
            washButtons.style.display = 'none';
            resetBtn.style.display = 'none';
            statsSummary.style.display = 'none';
        } else {
            selectionMode.style.display = 'none';
            washMode.style.display = 'block';
            washButtons.style.display = 'flex';
            resetBtn.style.display = 'inline-block';
            statsSummary.style.display = 'block';
        }
    }

    // éªŒè¯è¯æ¡é€‰æ‹©
    validateSelection() {
        for (let i = 0; i < 4; i++) {
            const typeSelect = document.getElementById(`type-${i}`);
            const qualitySelect = document.getElementById(`quality-${i}`);

            if (!typeSelect.value || !qualitySelect.value) {
                return false;
            }
        }
        return true;
    }

    // æ£€æŸ¥è¯æ¡æ˜¯å¦é‡å¤
    hasDuplicateTraits() {
        const selected = [];
        for (let i = 0; i < 4; i++) {
            const typeSelect = document.getElementById(`type-${i}`);
            const qualitySelect = document.getElementById(`quality-${i}`);

            if (typeSelect.value && qualitySelect.value) {
                const traitId = `${typeSelect.value}-${qualitySelect.value}`;
                if (selected.includes(traitId)) {
                    return true;
                }
                selected.push(traitId);
            }
        }
        return false;
    }

    // æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
    updateStartButton() {
        const startBtn = document.getElementById('startBtn');
        const isValid = this.validateSelection();
        const hasDuplicates = this.hasDuplicateTraits();

        startBtn.disabled = !isValid || hasDuplicates;

        if (hasDuplicates && isValid) {
            startBtn.textContent = 'è¯æ¡ä¸èƒ½é‡å¤';
        } else {
            startBtn.textContent = 'å¼€å§‹æ´—ç‚¼';
        }
    }

    // å¤„ç†è¯æ¡é€‰æ‹©å˜åŒ–
    handleSelectionChange() {
        this.updateStartButton();
    }

    // å¤„ç†å¼€å§‹æ´—ç‚¼
    handleStart() {
        if (!this.validateSelection() || this.hasDuplicateTraits()) {
            return;
        }

        // åˆ›å»ºåˆå§‹è¯æ¡
        const traits = [];
        for (let i = 0; i < 4; i++) {
            const typeSelect = document.getElementById(`type-${i}`);
            const qualitySelect = document.getElementById(`quality-${i}`);

            const type = typeSelect.value;
            const quality = QUALITY[qualitySelect.value];

            const trait = new Trait(type, quality);
            traits.push(trait);
        }

        // è®¾ç½®å½“å‰è¯æ¡
        this.washer.setCurrentTraits(traits);

        // åˆ‡æ¢åˆ°æ´—ç‚¼æ¨¡å¼
        this.isSelectionMode = false;
        this.displayTraits(traits, 'original');
        this.updateButtons();
        this.updateLockButtons();
        this.updateCostDisplay();
        this.updateStatsDisplay();
        this.updateUI();
    }

    // å¤„ç†é‡æ–°é€‰æ‹©
    handleReset() {
        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        this.washer.reset();
        this.isSelectionMode = true;

        // æ¸…ç©ºé€‰æ‹©
        for (let i = 0; i < 4; i++) {
            const typeSelect = document.getElementById(`type-${i}`);
            const qualitySelect = document.getElementById(`quality-${i}`);
            typeSelect.value = '';
            qualitySelect.value = '';
        }

        // æ¸…ç©ºè¯æ¡æ˜¾ç¤º
        for (let i = 0; i < 4; i++) {
            this.updateStatBox('original', i, null);
            this.updateStatBox('new', i, null);
        }

        // é‡ç½®æŒ‰é’®æ–‡æœ¬
        const washBtn = document.getElementById('washBtn');
        washBtn.textContent = 'æ´—ç‚¼';

        // æ›´æ–°ç•Œé¢
        this.updateUI();
        this.updateStartButton();
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateButtons() {
        const cancelBtn = document.getElementById('cancelBtn');
        const current = this.washer.getCurrentTraits();
        const newTraits = this.washer.getNewTraits();

        if (current.length === 0 && newTraits.length === 0) {
            // ä¸Šä¸‹æ å‡ä¸ºç©ºï¼Œå–æ¶ˆæŒ‰é’®ä¸å¯ç‚¹å‡»
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'å–æ¶ˆ';
        } else if (current.length > 0 && newTraits.length === 0) {
            // ä¸Šæ æœ‰è¯æ¡ï¼Œä¸‹æ æ²¡æœ‰ï¼Œæ˜¾ç¤º"æ¸…ç©º"
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'æ¸…ç©º';
        } else {
            // ä¸‹æ æœ‰è¯æ¡ï¼Œæ˜¾ç¤º"å–æ¶ˆ"
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'å–æ¶ˆ';
        }
    }

    // æ›´æ–°é”å®šæŒ‰é’®çŠ¶æ€
    updateLockButtons() {
        const lockState = this.washer.getLockState();
        const current = this.washer.getCurrentTraits();
        const lockedCount = lockState.filter(l => l).length;

        for (let i = 0; i < 4; i++) {
            const lockBtn = document.getElementById(`lock-${i}`);

            // åªæœ‰å½“æœ‰è¯æ¡æ—¶æ‰èƒ½é”å®š
            if (current.length === 0 || !current[i]) {
                lockBtn.disabled = true;
                lockBtn.classList.remove('locked');
            } else {
                // å¦‚æœå·²é”å®š3ä¸ªä¸”å½“å‰æœªé”å®šï¼Œåˆ™ç¦ç”¨ï¼ˆä¸èƒ½é”å®š4ä¸ªï¼‰
                if (lockedCount >= 3 && !lockState[i]) {
                    lockBtn.disabled = true;
                } else {
                    lockBtn.disabled = false;
                }

                if (lockState[i]) {
                    lockBtn.classList.add('locked');
                    lockBtn.textContent = 'ğŸ”’';
                } else {
                    lockBtn.classList.remove('locked');
                    lockBtn.textContent = 'ğŸ”“';
                }
            }
        }
    }

    // æ›´æ–°ææ–™æ¶ˆè€—æ˜¾ç¤º
    updateCostDisplay() {
        const washStoneEl = document.getElementById('washStone');
        const lockStoneEl = document.getElementById('lockStone');

        washStoneEl.textContent = this.washer.getWashStoneCost();
        lockStoneEl.textContent = this.washer.getLockCost();
    }

    // æ›´æ–°ææ–™ç»Ÿè®¡æ˜¾ç¤º
    updateStatsDisplay() {
        const totalWashStoneEl = document.getElementById('totalWashStone');
        const totalLockStoneEl = document.getElementById('totalLockStone');

        totalWashStoneEl.textContent = this.washer.getTotalWashStone();
        totalLockStoneEl.textContent = this.washer.getTotalLockStone();
    }

    // å¤„ç†é”å®šæŒ‰é’®ç‚¹å‡»
    handleLock(index) {
        this.washer.toggleLock(index);
        this.updateLockButtons();
        this.updateCostDisplay();
    }

    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        const washBtn = document.getElementById('washBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');

        washBtn.addEventListener('click', () => this.handleWash());
        cancelBtn.addEventListener('click', () => this.handleCancel());
        startBtn.addEventListener('click', () => this.handleStart());
        resetBtn.addEventListener('click', () => this.handleReset());

        // ç»‘å®šè¯æ¡é€‰æ‹©äº‹ä»¶
        for (let i = 0; i < 4; i++) {
            const typeSelect = document.getElementById(`type-${i}`);
            const qualitySelect = document.getElementById(`quality-${i}`);

            typeSelect.addEventListener('change', () => this.handleSelectionChange());
            qualitySelect.addEventListener('change', () => this.handleSelectionChange());
        }

        // ç»‘å®šé”å®šæŒ‰é’®äº‹ä»¶
        for (let i = 0; i < 4; i++) {
            const lockBtn = document.getElementById(`lock-${i}`);
            lockBtn.addEventListener('click', () => this.handleLock(i));
        }
    }

    // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
    displayInitialStats() {
        for (let i = 0; i < 4; i++) {
            this.updateStatBox('original', i, null);
            this.updateStatBox('new', i, null);
        }
        this.updateLockButtons();
        this.updateCostDisplay();
    }

    // æ›´æ–°è¯æ¡æ¡†æ˜¾ç¤º
    updateStatBox(row, index, trait) {
        const boxId = `${row}-${index}`;
        const box = document.getElementById(boxId);
        const nameEl = box.querySelector('.stat-name');
        const levelEl = box.querySelector('.stat-level');

        if (!trait) {
            nameEl.textContent = '-';
            levelEl.textContent = '';
            box.className = 'stat-box';
            return;
        }

        const { name, quality } = trait.getDisplayInfo();
        nameEl.textContent = name;
        levelEl.textContent = '';

        // ç§»é™¤æ‰€æœ‰å“è´¨ç±»
        box.className = 'stat-box';

        // æ·»åŠ å“è´¨ç±»
        if (quality === QUALITY.GOLD) {
            box.classList.add('quality-gold');
        } else if (quality === QUALITY.PURPLE) {
            box.classList.add('quality-purple');
        } else {
            box.classList.add('quality-blue');
        }

        // æ·»åŠ åŠ¨ç”»
        box.classList.add('animate');
        setTimeout(() => {
            box.classList.remove('animate');
        }, 400);
    }

    // æ˜¾ç¤ºè¯æ¡
    displayTraits(traits, row) {
        for (let i = 0; i < 4; i++) {
            if (i < traits.length) {
                this.updateStatBox(row, i, traits[i]);
            } else {
                this.updateStatBox(row, i, null);
            }
        }
    }

    // æ›´æ–°æ–°è¯æ¡æ˜¾ç¤º
    displayNewTraits(currentTraits, newTraits) {
        const lockState = this.washer.getLockState();

        for (let i = 0; i < 4; i++) {
            if (i < newTraits.length) {
                this.updateStatBox('new', i, newTraits[i]);

                // å¦‚æœè¯¥æ§½ä½è¢«é”å®šï¼Œæ·»åŠ é”å®šæ ‡è®°
                const boxId = `new-${i}`;
                const box = document.getElementById(boxId);
                if (lockState[i]) {
                    box.classList.add('locked-slot');
                } else {
                    box.classList.remove('locked-slot');
                }
            } else {
                this.updateStatBox('new', i, null);
            }
        }
    }

    // å¤„ç†æ´—ç‚¼
    handleWash() {
        if (this.isWashing) return;

        const washBtn = document.getElementById('washBtn');

        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ´—ç‚¼
        if (this.washer.getNewTraits().length > 0) {
            // å¦‚æœå·²æœ‰æ–°è¯æ¡ï¼Œæ´—ç‚¼æŒ‰é’®å˜ä¸º"ä¿å­˜"
            this.handleSave();
            washBtn.textContent = 'æ´—ç‚¼';
            return;
        }

        this.isWashing = true;
        washBtn.disabled = true;

        // æ¨¡æ‹Ÿæ´—ç‚¼åŠ¨ç”»å»¶è¿Ÿ
        setTimeout(() => {
            const result = this.washer.wash();

            // æ˜¾ç¤ºè¯æ¡
            this.displayTraits(result.current, 'original');
            this.displayNewTraits(result.current, result.new);

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            washBtn.textContent = 'ä¿å­˜ç»“æœ';
            washBtn.disabled = false;
            this.isWashing = false;
            this.updateButtons();
            this.updateLockButtons();
            this.updateCostDisplay();
            this.updateStatsDisplay();
        }, 300);
    }

    // å¤„ç†ä¿å­˜
    handleSave() {
        this.washer.saveResult();
        const current = this.washer.getCurrentTraits();

        // ä¿å­˜ååŸè¯æ¡æ˜¾ç¤ºæ–°è¯æ¡ï¼Œæ–°è¯æ¡è¡Œæ¸…ç©º
        this.displayTraits(current, 'original');
        this.displayTraits([], 'new');
        this.updateButtons();
        this.updateLockButtons();
        this.updateCostDisplay();
    }

    // å¤„ç†å–æ¶ˆ
    handleCancel() {
        const washBtn = document.getElementById('washBtn');

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å–æ¶ˆ
        if (this.washer.getNewTraits().length > 0) {
            this.washer.cancel();
            const current = this.washer.getCurrentTraits();

            // æ¢å¤æ˜¾ç¤ºå½“å‰è¯æ¡
            this.displayTraits(current, 'original');

            // æ¸…ç©ºæ–°è¯æ¡æ˜¾ç¤º
            for (let i = 0; i < 4; i++) {
                const boxId = `new-${i}`;
                const box = document.getElementById(boxId);
                const nameEl = box.querySelector('.stat-name');
                const levelEl = box.querySelector('.stat-level');
                nameEl.textContent = '-';
                levelEl.textContent = '';
                box.className = 'stat-box';
            }

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            washBtn.textContent = 'æ´—ç‚¼';
            this.updateButtons();
            this.updateLockButtons();
            this.updateCostDisplay();
        } else {
            // å¦‚æœæ²¡æœ‰æ–°è¯æ¡ï¼Œé‡ç½®æ‰€æœ‰
            this.washer.reset();
            this.displayInitialStats();
            this.updateButtons();
        }
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', () => {
    new App();
});
    </script>
</body>
</html>
